go_import_path: github.com/redhat-developer/service-binding-operator
sudo: required
dist: xenial
language: go

go:
- 1.13.x

env:
  global:
    - SDK_VERSION="0.8.1"
    - GO111MODULE=on
    - USER="redhat-developer"
    - EMAIL="openshift-dev-services@redhat.com"
    - REPO="service-binding-operator"
    - FILES="./tmp/manifests"
    - GH_REPO="github.com/${USER}/${REPO}.git"
    - GH_REMOTE_REPO="github.com/${USER}/service-binding-operator-manifests"

before_install:
# Download Operator SDK
- curl -Lo operator-sdk https://github.com/operator-framework/operator-sdk/releases/download/v${SDK_VERSION}/operator-sdk-v${SDK_VERSION}-x86_64-linux-gnu && chmod +x operator-sdk && mv operator-sdk $GOPATH/bin/

script:
# Run merge-to-master-release
- if [ "$TRAVIS_BRANCH" = "testing-quay" ]; then
  make merge-to-master-release;
  make push-to-manifest-repo; 
  fi


after_success:
- MESSAGE=$(git log --format=%B -n 1 $TRAVIS_COMMIT)
- git clone git://${GH_REPO}
- git clone git://${GH_REMOTE_REPO}
- cd service-binding-operator
- git checkout testing-quay
- cp ${FILES} ${GH_REMOTE_REPO}/
- cd service-binding-operator-manifests
- git config user.email ${EMAIL}
- git config user.name ${USER}
- git add ${FILES}
- git commit -m ${MESSAGE}
- git push "https://${GITHUB_TOKEN}@${GH_REMOTE_REPO}" master > /dev/null 2>&1
